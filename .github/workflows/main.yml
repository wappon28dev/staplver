name: make release packages

on:
    push:
        branches:
            - main
    pull_request:
        types: [opened, synchronize, reopened]
        paths:
            - "lib/**"
    workflow_dispatch:

jobs:
    build-and-release-windows:
        runs-on: windows-latest

        steps:
            - uses: actions/checkout@v3
            - uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  cache: true

            - name: ğŸ‰ Install project dependencies
              run: flutter pub get

            - name: ğŸ“¦ï¸ Generate intermediates
              run: flutter pub run build_runner build --delete-conflicting-outputs

            - name: ğŸ Enable windows build
              run: flutter config --enable-windows-desktop

            - name: ğŸ± Build artifacts
              run: flutter build windows --release

            - name: ğŸš€ Make windows release zip
              uses: thedoctor0/zip-release@0.6.2
              with:
                  type: "zip"
                  filename: AIBAS-windows.zip
                  directory: build/windows/runner/Release

            - name: â¬†ï¸ artifact upload
              uses: actions/upload-artifact@v3.1.1
              with:
                  name: AIBAS-windows
                  path: build/windows/runner/Release/AIBAS-windows.zip
                  retention-days: 90

            - name: ğŸšš Windows Release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  files: build/windows/runner/Release/AIBAS-windows.zip

    build-and-release-macos:
        runs-on: macos-latest

        steps:
            - uses: actions/checkout@v3

            - uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  cache: true

            - name: ğŸ‰ Install project dependencies
              run: flutter pub get

            - name: ğŸ“¦ï¸ Generate intermediates
              run: flutter pub run build_runner build --delete-conflicting-outputs

            - name: ğŸ Enable macOS build
              run: flutter config --enable-macos-desktop

            - name: ğŸ± Build artifacts
              run: flutter build macos --release

            - name: ğŸš€ Make macos release zip
              uses: thedoctor0/zip-release@0.6.2
              with:
                  type: "zip"
                  filename: AIBAS-macos.zip
                  directory: build/macos/Build/Products/Release

            - name: â¬†ï¸ artifact upload
              uses: actions/upload-artifact@v3.1.1
              with:
                  name: AIBAS-macOS
                  path: build/windows/runner/Release/AIBAS-macOS.zip
                  retention-days: 90

            - name: ğŸšš macOS Release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  files: build/macos/Build/Products/Release/AIBAS-macos.zip

    build-and-release-linux:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  cache: true

            - name: ğŸ‰ Install project dependencies
              run: flutter pub get

            - name: ğŸ“¦ï¸ Generate intermediates
              run: flutter pub run build_runner build --delete-conflicting-outputs

            - name: ğŸ§ Enable Linux build
              run: |
                  sudo apt-get update -y
                  sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
                  flutter config --enable-linux-desktop

            - name: ğŸ± Build artifacts
              run: flutter build linux --release

            - name: ğŸš€ Make macos release zip
              uses: thedoctor0/zip-release@0.6.2
              with:
                  type: "zip"
                  filename: AIBAS-linux.zip
                  directory: build/linux/Build/Products/Release

            - name: â¬†ï¸ artifact upload
              uses: actions/upload-artifact@v3.1.1
              with:
                  name: AIBAS-linux
                  path: build/windows/runner/Release/AIBAS-linux.zip
                  retention-days: 90

            - name: ğŸšš macOS Release
              uses: softprops/action-gh-release@v1
              if: startsWith(github.ref, 'refs/tags/')
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  files: build/linux/Build/Products/Release/AIBAS-linux.zip
